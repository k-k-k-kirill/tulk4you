- pipeline: "Deploy to production"
  on: "CLICK"
  refs:
  - "refs/heads/master"
  priority: "NORMAL"
  fail_on_prepare_env_warning: true
  actions:
  - action: "Install NPM packages and build"
    type: "BUILD"
    working_directory: "/buddy/tulk4you"
    docker_image_name: "library/node"
    docker_image_tag: "14"
    execute_commands:
    - "cd web/app/themes/tulk4you-theme"
    - "yarn"
    - "yarn build"
    volume_mappings:
    - "/:/buddy/tulk4you"
    shell: "BASH"
  - action: "Upload files to production"
    type: "SFTP"
    input_type: "SCM_REPOSITORY"
    remote_path: "deploy-cache"
    login: "${ssh_username}"
    password: "secure!TlPofdbH/7NnMSA803mzCw==.2lQK6n3PrbHj53nk2KtcUQ=="
    host: "35.228.245.82"
    port: "43336"
    authentication_mode: "PASS"
  - action: "Install composer dependencies"
    type: "SSH_COMMAND"
    login: "${ssh_username}"
    password: "secure!TlPofdbH/7NnMSA803mzCw==.2lQK6n3PrbHj53nk2KtcUQ=="
    host: "35.228.245.82"
    port: "43336"
    authentication_mode: "PASS"
    commands:
    - "cd deploy-cache && composer install"
    - "cd web/app/plugins/tulk4you-plugin && composer install"
    - "cd ../../themes/tulk4you-theme && composer install"
    run_as_script: true
    shell: "BASH"
  - action: "Post-deployment action"
    type: "SSH_COMMAND"
    login: "${ssh_username}"
    password: "secure!TlPofdbH/7NnMSA803mzCw==.2lQK6n3PrbHj53nk2KtcUQ=="
    host: "35.228.245.82"
    port: "43336"
    authentication_mode: "PASS"
    commands:
    - "if [ -d \"releases/$BUDDY_EXECUTION_REVISION\" ] && [ \"$BUDDY_EXECUTION_REFRESH\" = \"true\" ];"
    - "then"
    - " echo \"Removing: releases/$BUDDY_EXECUTION_REVISION\""
    - " rm -rf releases/$BUDDY_EXECUTION_REVISION;"
    - "fi"
    - ""
    - "if [ ! -d \"releases/$BUDDY_EXECUTION_REVISION\" ];"
    - "then"
    - " echo \"Creating: releases/$BUDDY_EXECUTION_REVISION\""
    - " cp -dR deploy-cache releases/$BUDDY_EXECUTION_REVISION;"
    - "fi"
    - ""
    - "echo \"Copying ENV of current revision: $BUDDY_EXECUTION_REVISION\""
    - "cp -n releases/$BUDDY_EXECUTION_REVISION/.env.example shared/.env"
    - "cp shared/.env releases/$BUDDY_EXECUTION_REVISION/.env"
    - "echo \"Linking current to revision: $BUDDY_EXECUTION_REVISION\""
    - "rm -f current"
    - "ln -s releases/$BUDDY_EXECUTION_REVISION current"
    - "echo \"Linking uploads of current revision: $BUDDY_EXECUTION_REVISION\""
    - "mkdir -p shared"
    - "rm -f shared/uploads"
    - "ln -s releases/$BUDDY_EXECUTION_REVISION/web/uploads shared"
    - ""
    - "echo \"Removing old releases\""
    - "cd releases && ls -t | tail -n +11 | xargs rm -rf"
    run_as_script: true
    shell: "BASH"
  variables:
  - key: "ssh_password"
    value: "secure!GXcNe59stuBUrOahdhRsIA==.0QK3qYTzHq/6XB1IVDUfnw=="
    type: "VAR"
    encrypted: true
  - key: "ssh_username"
    value: "tulk4you"
    type: "VAR"
