- pipeline: "Deploy to production"
  on: "CLICK"
  refs:
  - "refs/heads/master"
  priority: "NORMAL"
  fail_on_prepare_env_warning: true
  actions:
  - action: "Upload files to production"
    type: "SFTP"
    input_type: "SCM_REPOSITORY"
    remote_path: "deploy-cache"
    login: "${ssh_username}"
    password: "secure!TlPofdbH/7NnMSA803mzCw==.2lQK6n3PrbHj53nk2KtcUQ=="
    host: "35.228.245.82"
    port: "43336"
    authentication_mode: "PASS"
  - action: "Post-deployment action"
    type: "SSH_COMMAND"
    login: "${ssh_username}"
    password: "secure!TlPofdbH/7NnMSA803mzCw==.2lQK6n3PrbHj53nk2KtcUQ=="
    host: "35.228.245.82"
    port: "43336"
    authentication_mode: "PASS"
    commands:
    - "if [ -d \"releases/$BUDDY_EXECUTION_REVISION\" ] && [ \"$BUDDY_EXECUTION_REFRESH\" = \"true\" ];"
    - "then"
    - " echo \"Removing: releases/$BUDDY_EXECUTION_REVISION\""
    - " rm -rf releases/$BUDDY_EXECUTION_REVISION;"
    - "fi"
    - ""
    - "if [ ! -d \"releases/$BUDDY_EXECUTION_REVISION\" ];"
    - "then"
    - " echo \"Creating: releases/$BUDDY_EXECUTION_REVISION\""
    - " cp -dR deploy-cache releases/$BUDDY_EXECUTION_REVISION;"
    - "fi"
    - ""
    - "echo \"Linking current to revision: $BUDDY_EXECUTION_REVISION\""
    - "rm -f current"
    - "ln -s releases/$BUDDY_EXECUTION_REVISION current"
    - "echo \"Linking uploads of current revision: $BUDDY_EXECUTION_REVISION\""
    - "if [ -d \"shared/uploads\" ];"
    - "then"
    - "rm -f shared/uploads"
    - "ln -s shared/uploads current/web/app/uploads"
    - "fi"
    - "if [ ! -d \"shared/uploads\" ];"
    - "then"
    - "mkdir -p shared/uploads"
    - "ln -s shared/uploads current/web/app/uploads"
    - "fi"
    - ""
    - "echo \"Removing old releases\""
    - "cd releases && ls -t | tail -n +11 | xargs rm -rf"
    run_as_script: true
    shell: "BASH"
  variables:
  - key: "ssh_password"
    value: "secure!GXcNe59stuBUrOahdhRsIA==.0QK3qYTzHq/6XB1IVDUfnw=="
    type: "VAR"
    encrypted: true
  - key: "ssh_username"
    value: "tulk4you"
    type: "VAR"
